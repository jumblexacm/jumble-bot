# ACM x Jumble


## Prerequisites

- Discord account

- Discord server (your "dev server")

- AWS account


## STEP 1: Create the Discord bot

https://discord.com/developers/docs/intro

1. Create the [team](https://discord.com/developers/docs/topics/teams)
    - Visit https://discord.com/developers/teams
    - Click **[New Team]**
    - To add the other engineers, open the new team and **"Invite team members"**

2. Create the [app](https://discord.com/developers/docs/intro#bots-and-apps)
    - Visit https://discord.com/developers/applications
    - Click **[New application]**
    - Choose your team from earlier (not your personal team)

3. Add the redirect URI
    - Input your app's about page or another URL for the user to see after installing your app

3. Create the bot  
(As far as [@kirmar](https://github.com/kirmar) can tell, the app must have a bot user to join a server / read any messages.)
    - Menu section: **"Bot"**
    - Click **[Add Bot]**
    - Under **"Privileged Gateway Intents"**, check `Message Content Intent`

4. Generate the invite URL
    - Menu section: **"OAuth2"** > **"URL Generator"**
    - Choose [permissions](https://discord.com/developers/docs/topics/oauth2#oauth2):
        - Under **"Scopes"**, check `bot`
        - Under **"Bot Permissions"**, check `Read Messages/View Channels`
    - As your redirect URL, choose your redirect URI from earlier
    - Copy the generated URL, because it disappears if you navigate away from the page. This URL lets you add the bot to a server, for now your dev server.


## STEP 2: Create a test student org server

1. In Discord, click **[Add a Server]** and follow the steps

2. Under **"Server Settings"** > **"Enable Community"**, click **[Get Started]** and follow the steps

3. Click the plus symbol to **"Create Channel"**, check `Announcement`, and create the channel

4. Next to the new channel name, click **"Follow"** and choose your dev server where you installed the bot

Notes about community servers:
- For a message to appear in the dev server, the person posting in the student org server must send the message *and* click "Publish."
- When someone edits the message in the student org server, it also updates in the dev server.


## STEP 3: Create the admin IAM role and first user

https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html

1. Sign in as the root user in your AWS account

2. Create an IAM [admin role](https://alestic.com/2014/09/aws-root-password/)
    - In the Identity and Access Management (IAM) console, click **"Roles"** and **[Create role]**
    - Trusted entity type: `AWS account`
    - An AWS account: `This account`
    - Options: `Require MFA`
    - Add permissions: `AdministratorAccess`
    - Name: `admin`

3. Create an IAM "assume admin role" [permissions policy](https://docs.aws.amazon.com/lambda/latest/dg/security_iam_id-based-policy-examples.html)
    - In the IAM console, click **"Policies"** and **[Create policy]**
    - Add Lambda function view/edit permissions
        - Service: `STS`
        - Actions:
            - `Write` > `AssumeRole`
        - Resources: `Specific`
            - **"Add ARN"**
            - Paste the ARN from the `admin` role summary
        - Request conditions: `MFA required`
    - Name: `jumble-assume-admin-policy`

4. Create your IAM [user](https://docs.aws.amazon.com/IAM/latest/UserGuide/id.html#id_which-to-choose)
    - In the IAM console, click **"Users"** and **[Add users]**
    - User name: *[Input your name]*
        - Example: `kira`
    <!--- - Select AWS credential type: `Access key - Programmatic access` -->
    - Select AWS access type
        - Select AWS credential type: `Password - AWS Management Console access`
        - Console password: `Autogenerated password`
        - Require password reset: `Users must create a new password at next sign-in`
    - Attach existing policies directly: `jumble-assume-admin-policy`
    - After creating the user, save the credentials immediately to a safe place, because they disappear forever if you navigate away from the page

5. Assume the admin role
    - Get the link
        - In the IAM console, click **"Roles"**
        - Open `admin`
        - Copy and save the "switch roles" link
    - Sign out of the AWS account
    - Sign in as your IAM user
    - Visit the "switch roles" link

6. From now on, use the admin role any time you need full permissions, instead of using the root user directly


## STEP 4: Create the engineer IAM role

1. After assuming the admin role, create an IAM policy for managing Lambda
    - In the IAM console, click **"Policies"** and **[Create policy]**
    - Add Lambda function view/edit permissions
        - Service: `Lambda`
        - Actions:
            - `Read`
                - `GetAccountSettings` (to view the list of all functions in the Lambda console)
                - `GetFunction` (to view a function's code, logs, and settings)
            - `List`
                - `ListFunctions` (to view the list of all functions in the Lambda console)
                - `ListFunctionUrlConfigs` (to view a function URL)
            - `Write`
                - `CreateRole` (to create a function)
                - `PassRole` (to create a function)
                - `CreateFunctionUrlConfig` (to create a function URL)
            - `Permissions management`
                - `AttachRolePolicy` (to create a function)
                - `CreatePolicy` (to create a function)
        - Resources: `All resources`
        - Request conditions: `MFA required`
    - Name: `jumble-lambda-policy`

2. Create an IAM engineer role
    - In the IAM console, click **"Roles"** and **[Create role]**
    - Trusted entity type: `AWS account`
    - An AWS account: `This account`
    - Options: `Require MFA`
    - Add permissions: `jumble-lambda-policy`
    - Name: `engineer`

3. Create an IAM "assume engineer role" policy
    - Use most of the same steps from `jumble-assume-admin-policy`
    - However, paste the ARN from the `engineer` role summary (not the admin role's summary)


## STEP 5: Finish creating the IAM users

1. For each engineer who needs access to your AWS resources (like your Lambda function), create an IAM user
    - Use the same steps from earlier

2. For each user (including the first IAM user from earlier), add the `jumble-assume-engineer-policy`
    - In the IAM console, click **"Users"** and choose the IAM user
    - Click **"Add permissions"**
    - Attach existing policies directly: `jumble-assume-admin-policy`

3. Have each user set up MFA by following these steps:
    - Sign in as the IAM user
    - Visit the "switch roles" link for the admin role
    - In the IAM console, click **"Users"** and choose an IAM user
    - Click **"Security credentials"**
    - Assigned MFA device: `Manage`
    - Work with the user to set up their MFA of choice

4. Optional: To make the sign-in URL simpler for IAM users and something that isn't a secret, create an [account alias](https://docs.aws.amazon.com/IAM/latest/UserGuide/console_account-alias.html#CreateAccountAlias)
    - In the IAM console, click **"Dashboard"**
    - Under **"AWS Account"** > **"Account Alias"**, click **[Create]** and choose a unique alias with no private information

5. Send each user's credentials securely to the user


## STEP 6: Set up the AWS Lambda function

1. After assuming the admin role, create the function
    - In the Lambda console, click **"Dashboard"** and **[Create function]**
    - Check `Author from scratch`
    - Function name: `jumble-bot-function`
    - Execution role: `Create a new role with basic Lambda permissions`
    - Create a URL
        - Under **"Advanced settings"**, check `Enable function URL`
        - Auth type: `NONE` (We'll authenticate within the Lambda function)

2. As any user, create the function URL
    - In the Lambda console, click **[Functions]** and open `jumble-bot-function`
    - Under **"Configuration"**, click **[Create function URL]**


## Resources

https://discord.com/developers/docs/resources/channel#get-channel-messages

https://github.com/kkrypt0nn/Python-Discord-Bot-Template


## Repo conventions

Branch naming convention
- `<team>/<trello-task>/<description>`
- Example: `bot/STA-7/get-announcement-data`

Pull request (PR) conventions
- At the top of the description, include the Trello ticket:

      [STA-10](link)
      This ticket entails...

- PRs aren't needed for README updates. (Commit directly to `main`)
